<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>
    <title>结算页</title>

    <link rel="stylesheet" type="text/css" href="../../js/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../../js/shop/css/webbase.css"/>
    <link rel="stylesheet" type="text/css" href="../../js/shop/css/pages-getOrderInfo.css"/>
</head>

<body>
<!--head-->
<div class="top">
    <div class="py-container">
        <div class="shortcut">
            <!--<ul class="fl">
                <li class="f-item">品优购欢迎您！</li>
                <li class="f-item">请登录　<span><a href="#">免费注册</a></span></li>
            </ul>-->
            <ul class="fr">
                <li class="f-item">我的订单</li>
                <li class="f-item space"></li>
                <li class="f-item">我的品优购</li>
                <li class="f-item space"></li>
                <li class="f-item">品优购会员</li>
                <li class="f-item space"></li>
                <li class="f-item">企业采购</li>
                <li class="f-item space"></li>
                <li class="f-item">关注品优购</li>
                <li class="f-item space"></li>
                <li class="f-item">客户服务</li>
                <li class="f-item space"></li>
                <li class="f-item">网站导航</li>
            </ul>
        </div>
    </div>
</div>
<!--body-->
<div class="cart py-container">
    <!--logoArea-->
    <div class="logoArea">
        <div class="fl logo"><span class="title">结算页</span></div>
        <div class="fr search">
            <form class="sui-form form-inline">
                <div class="input-append">
                    <input type="text" type="text" class="input-error input-xxlarge" placeholder="品优购自营"/>
                    <button class="sui-btn btn-xlarge btn-danger" type="button">搜索</button>
                </div>
            </form>
        </div>
    </div>

    <!--主内容-->
    <div class="checkout py-container">
        <div class="checkout-tit">
            <h4 class="tit-txt">填写并核对订单信息</h4>
        </div>
        <div class="checkout-steps">
            <!--收件人信息-->
            <div class="step-tit">
                <h5>收件人信息<span><a class="newadd" onclick="showAddDlg()">新增收货地址</a></span></h5>
            </div>
            <div class="step-cont">
                <div class="addressInfo">
                    <!--用户的收货地址进行展示-->
                    <ul class="addr-detail">
                        <li class="addr-item" id="shouHuoArea">

                        </li>
                    </ul>

                    <!--添加地址-->
                    <!--<div tabindex="-1" role="dialog" data-hasfoot="false" class="sui-modal hide fade edit">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close">×
                                    </button>
                                    <h4 id="myModalLabel" class="modal-title">添加收货地址</h4>
                                </div>
                                <div class="modal-body">
                                    <form action="" class="sui-form form-horizontal">
                                        <div class="control-group">
                                            <label class="control-label">收货人：</label>
                                            <div class="controls">
                                                <input type="text" class="input-medium" id="userName">
                                            </div>
                                        </div>

                                        <div class="control-group">
                                            <label class="control-label">详细地址：</label>
                                            <div class="controls">
                                                <input type="text" class="input-large" id="area">
                                            </div>
                                        </div>

                                        <div class="control-group">
                                            <label class="control-label">联系电话：</label>
                                            <div class="controls">
                                                <input type="text" class="input-medium" id="phone">
                                            </div>
                                        </div>

                                        <div class="control-group">
                                            <label class="control-label">默认地址：</label>
                                            <div class="controls">
                                                <input type="radio" value="1" class="input-medium" name="status"
                                                       checked>是
                                                <input type="radio" value="0" class="input-medium" name="status">否
                                            </div>
                                        </div>

                                    </form>


                                </div>
                                <div class="modal-footer">
                                    <button type="button" data-ok="" class="sui-btn btn-primary btn-large"
                                            onclick="addShouHuoArea()">确定
                                    </button>
                                    <button type="button" data-dismiss="modal" class="sui-btn btn-default btn-large">
                                        取消
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>-->
                </div>
                <div class="hr"></div>

            </div>
            <div class="hr"></div>
            <!--支付和送货-->
            <div class="payshipInfo">
                <div class="step-tit">
                    <h5>支付方式</h5>
                </div>
                <div class="step-cont">
                    <ul class="payType">
                        <li class="selected">支付宝付款<span title="点击取消选择"></span></li>
                        <li>微信付款<span title="点击取消选择"></span></li>
                        <li>货到付款<span title="点击取消选择"></span></li>
                    </ul>
                </div>
                <div class="hr"></div>
                <div class="step-tit">
                    <h5>送货清单</h5>
                </div>

                <div class="step-cont" id="shopDiv">

                </div>

                <div class="hr"></div>
            </div>

            <div class="linkInfo">
                <div class="step-tit">
                    <h5>发票信息</h5>
                </div>
                <div class="step-cont">
                    <span>普通发票（电子）</span>
                    <span>个人</span>
                    <span>明细</span>
                </div>
            </div>

            <div class="cardInfo">
                <div class="step-tit">
                    <h5>使用优惠/抵用</h5>
                </div>
            </div>
        </div>
    </div>

    <div class="order-summary" id="shopWeiDiv">

    </div>
    <div class="clearfix trade" id="shopMWDiv">

    </div>
    <div class="submit">
        <a class="sui-btn btn-danger btn-xlarge" href="#" onclick="submitOrder();">提交订单</a>
    </div>
</div>

<!-- 底部栏位 -->
<!--页面底部-->
<div class="clearfix footer">
    <div class="py-container">
        <div class="footlink">
            <div class="Mod-service">
                <ul class="Mod-Service-list">
                    <li class="grid-service-item intro  intro1">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item  intro intro2">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item intro  intro3">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item  intro intro4">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item intro intro5">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                </ul>
            </div>
            <div class="clearfix Mod-list">
                <div class="yui3-g">
                    <div class="yui3-u-1-6">
                        <h4>购物指南</h4>
                        <ul class="unstyled">
                            <li>购物流程</li>
                            <li>会员介绍</li>
                            <li>生活旅行/团购</li>
                            <li>常见问题</li>
                            <li>购物指南</li>
                        </ul>

                    </div>
                    <div class="yui3-u-1-6">
                        <h4>配送方式</h4>
                        <ul class="unstyled">
                            <li>上门自提</li>
                            <li>211限时达</li>
                            <li>配送服务查询</li>
                            <li>配送费收取标准</li>
                            <li>海外配送</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>支付方式</h4>
                        <ul class="unstyled">
                            <li>货到付款</li>
                            <li>在线支付</li>
                            <li>分期付款</li>
                            <li>邮局汇款</li>
                            <li>公司转账</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>售后服务</h4>
                        <ul class="unstyled">
                            <li>售后政策</li>
                            <li>价格保护</li>
                            <li>退款说明</li>
                            <li>返修/退换货</li>
                            <li>取消订单</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>特色服务</h4>
                        <ul class="unstyled">
                            <li>夺宝岛</li>
                            <li>DIY装机</li>
                            <li>延保服务</li>
                            <li>品优购E卡</li>
                            <li>品优购通信</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                    </div>
                </div>
            </div>
            <div class="Mod-copyright">
                <ul class="helpLink">
                    <li>关于我们<span class="space"></span></li>
                    <li>联系我们<span class="space"></span></li>
                    <li>关于我们<span class="space"></span></li>
                    <li>商家入驻<span class="space"></span></li>
                    <li>营销中心<span class="space"></span></li>
                    <li>友情链接<span class="space"></span></li>
                    <li>关于我们<span class="space"></span></li>
                    <li>营销中心<span class="space"></span></li>
                    <li>友情链接<span class="space"></span></li>
                    <li>关于我们</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!--页面底部END-->

<!--收货地址展示-->
<div id="shouHuoAreaData" style="display: none">
    <div id="shouHuoAreaData1" border="1px">
        <div class="con name ##check##" onclick="updateShouHuoStatus('##id##')"><a href="javascript:;">##userName##<span
                title="点击取消选择">&nbsp;</span></a>
        </div>
        <div class="con address" onclick="updateArea('##id##',this)">##userName##&nbsp;&nbsp;&nbsp;##area##&nbsp;&nbsp;&nbsp;<span>##phone##</span>
            ##defalutArea##
            <span style="display: none">
                <!-- data-toggle="modal" data-target=".edit" data-keyboard="false"-->
                <a href="javascript:;" onclick="updateAreaData('##id##')">编辑</a>&nbsp;&nbsp;
                <a href="javascript:;" onclick="delShouHuo('##id##')">删除</a></span>
        </div>
        <div class="clearfix"></div>
    </div>

    <!--  <div id="shouHuoAreaData0">
          <div class="con name" onclick="updateShouHuoStatus('##id##')"><a href="javascript:;">##userName##<span
                  title="点击取消选择">&nbsp;</span></a>
          </div>
          <div class="con address">##userName##&nbsp;&nbsp;&nbsp;##area## &nbsp;&nbsp;&nbsp;<span>##phone##</span>
              <span style="display: none">
                  &lt;!&ndash; data-toggle="modal" data-target=".edit" data-keyboard="true"&ndash;&gt;
                  <a>编辑</a>&nbsp;&nbsp;
                  <a href="javascript:;" onclick="delShouHuo('##id##')">删除</a>
              </span>
          </div>
          <div class="clearfix"></div>
      </div>-->
</div>
<!--送货清单展示-->
<div id="shopData" style="display: none">
    <ul class="send-detail">
        <li>
            <div class="sendGoods">
                <ul class="yui3-g">
                    <li class="yui3-u-1-6">
                        <!--<span><img src="img/goods.png"/></span>-->
                        <span><img src="##skuImage##"/></span>
                    </li>
                    <li class="yui3-u-7-12">
                        <div class="desc">##skuName##</div>
                        <div class="seven">7天无理由退货</div>
                    </li>
                    <li class="yui3-u-1-12">
                        <div class="price">##subPrice##</div>
                    </li>
                    <li class="yui3-u-1-12">
                        <div class="num">X##count##</div>
                    </li>
                    <li class="yui3-u-1-12">
                        <div class="exit">有货</div>
                    </li>
                </ul>
            </div>
        </li>
        <li></li>
        <li></li>
    </ul>
</div>
<!--订单尾部-->
<div id="shopWeiData" style="display: none">
    <div class="static fr">
        <div class="list">
            <span><i class="number">##totalCount##</i>件商品，总商品金额</span>
            <em class="allprice">¥##totalPrice##</em>
        </div>
        <div class="list">
            <span>返现：</span>
            <em class="money">0.00</em>
        </div>
        <div class="list">
            <span>运费：</span>
            <em class="transport">0.00</em>
        </div>
    </div>
</div>
<!--订单末尾-->
<div id="shopMWData" style="display: none">
    <div class="fc-price">应付金额:　<span class="price">¥##totalPrice##</span></div>
    <div class="fc-receiverInfo" id="areaDiv"></div>
</div>
<!--新增收货人信息的弹框-->
<div id="addShouHuoDiv" style="display: none">
    <form class="form-horizontal">
        <div class="form-group">
            <label class="col-sm-2 control-label">收货人:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="userName" name="brandName" placeholder="请输入收货人">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">详细地址:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="area" name="brandName" placeholder="请输入详细地址">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">手机号:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="phone" name="brandName" placeholder="请输入手机号">
            </div>
        </div>
    </form>
</div>
<!--修改收货人信息的弹框-->
<div id="updateShouHuoDiv" style="display: none">
    <form class="form-horizontal">
        <div class="form-group">
            <input type="hidden" id="update_id" name="id">
            <label class="col-sm-2 control-label">收货人:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="update_userName" name="brandName" placeholder="请输入收货人">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">详细地址:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="update_area" name="brandName" placeholder="请输入详细地址">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">手机号:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="update_phone" name="brandName" placeholder="请输入手机号">
            </div>
        </div>
    </form>
</div>

<script type="text/javascript" src="../../js/shop/js/plugins/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../js/shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
<script type="text/javascript" src="../../js/shop/js/plugins/sui/sui.min.js"></script>
<script type="text/javascript" src="../../js/shop/js/pages/getOrderInfo.js"></script>

<script src="../../js/bootbox/bootbox.min.js"></script>
<script src="../../js/bootbox/bootbox.locales.min.js"></script>
<script src="../../js/bootstrap/js/bootstrap.min.js"></script>

<script type="text/javascript" src="../../js/common/server_url.js"></script>
<script src="../../js/jquery.cookie.min.js"></script>
<script>
    $(function () {
        //初始化查询用户收货地址
        initShouHuoArea();
        //初始化查询送货清单数据
        initShopData();
        //获取token
        findToken();
    })

    var aretaListSelect;//点击后边的进行选中项
    var aretaList;//收货地址的所有数据

    var x_token;
    function findToken() {
        $.ajax({
            type: "post",
            url: server_url + "/tokens/createToken",
            beforeSend: function (xhr) {
                xhr.setRequestHeader(AUTH, $.cookie(TOKEN));
            },
            success:function (res) {
                if(res.code == 200){
                    v_token = res.data;
                }
            }
        })
    }

    function submitOrder() {
        if (!aretaListSelect) {
            alert("请选择收件人");
            return;
        }
        var v_param = {};
        v_param.payType = 1;
        v_param.recipientId = aretaListSelect.id;
        $.ajax({
            type: "post",
            url: server_url + "/orders/addOrder",
            beforeSend: function (xhr) {
                xhr.setRequestHeader(AUTH, $.cookie(TOKEN));
                xhr.setRequestHeader(XTOKEN,x_token);
            },
            data: v_param,
            success: function (res) {
                console.log(res);
                if(res.code == 200){
                    location.href="order.html";
                }
            }
        })
    }


    function updateArea(id, obj) {
        for (var item of aretaList) {
            if (item.id == id) {
                aretaListSelect = item;
                $("#areaDiv").html("寄送至:" + item.area + " 收货人：" + item.userName + " " + item.phone);
            }
            $(".con.address").css("font-weight", "");
            $(obj).css("font-weight", "bold");
        }
    }

    //打开新增的弹框
    function showAddDlg() {
        //
        var html = $("#addShouHuoDiv").html();
        var v_Dlg = bootbox.dialog({
            title: "增加收货人信息",
            message: $("#addShouHuoDiv form"),
            size: 'large',
            buttons: {
                confirm: {
                    label: ' <span class="glyphicon glyphicon-ok"></span>确认',
                    className: 'btn-primary',
                    callback: function () {
                        addShouHuoArea(v_Dlg);
                    }
                },
                cancel: {
                    label: ' <span class="glyphicon glyphicon-remove"></span>取消',
                    className: 'btn-danger'
                }
            }

        });
        $("#addShouHuoDiv").html(html);
    }

    //修改的弹框
    function updateAreaData(id) {
        for (var item of aretaList) {
            if (item.id == id) {
                //打开修改的弹框
                $("#update_area").val(item.area);
                $("#update_phone").val(item.phone);
                $("#update_userName").val(item.userName);
                $("#update_id").val(id);

                var html = $("#updateShouHuoDiv").html();
                var v_Dlg = bootbox.dialog({
                    title: "增加收货人信息",
                    message: $("#updateShouHuoDiv form"),
                    size: 'large',
                    buttons: {
                        confirm: {
                            label: ' <span class="glyphicon glyphicon-ok"></span>确认',
                            className: 'btn-primary',
                            callback: function () {
                                updateShouHuoArea(v_Dlg);
                            }
                        },
                        cancel: {
                            label: ' <span class="glyphicon glyphicon-remove"></span>取消',
                            className: 'btn-danger'
                        }
                    }

                });
                $("#updateShouHuoDiv").html(html);
            }
        }
    }

    //查询送货清单数据
    function initShopData() {
        $.ajax({
            type: "get",
            url: server_url + "/dingdan/queryShopData",
            beforeSend: function (xhr) {//设置头部信息
                xhr.setRequestHeader(AUTH, $.cookie(TOKEN));
            }, success: function (res) {
                if (res.code == 200) {
                    if (!res.data) {
                        location.href = "cart.html"
                        return;
                    }
                    var shopData = $("#shopData").html();
                    var data = res.data.cartItemVoList;
                    var html = "";
                    for (let i = 0; i < data.length; i++) {
                        html += shopData.replace(/##skuImage##/g, data[i].skuImage)
                            .replace(/##skuName##/g, data[i].skuName)
                            .replace(/##subPrice##/g, data[i].subPrice)
                            .replace(/##count##/g, data[i].count);
                    }
                    $("#shopDiv").html(html);

                    $("#shopWeiDiv").html($("#shopWeiData").html().replace(/##totalCount##/g, res.data.totalCount).replace(/##totalPrice##/g, res.data.totalPrice));

                    $("#shopMWDiv").html($("#shopMWData").html().replace(/##totalPrice##/g, res.data.totalPrice));
                } else if (res.code == 6008 || res.code == 6010 || res.code == 6005) {//登录超时  信息不完整  头信息为空
                    location.href = "list.html";//跳转到登录页面
                }
            }, error: function (e) {
                alert("异常");
            }
        })
    }

    //修改默认地址
    function updateShouHuoStatus(id) {
        $.ajax({
            type: "post",
            url: server_url + "/dingdan/updateShouHuoAreaStatus",
            data: {"id": id},
            beforeSend: function (xhr) {//设置头部信息
                xhr.setRequestHeader(AUTH, $.cookie(TOKEN));
            }, success: function (res) {
                if (res.code == 200) {
                    initShouHuoArea();
                } else if (res.code == 6008 || res.code == 6010 || res.code == 6005) {//登录超时  信息不完整  头信息为空
                    location.href = "list.html";//跳转到登录页面
                }
            }, error: function (e) {
                alert("异常");
            }
        })
    }


    //查询用户收货地址
    function initShouHuoArea() {
        $.ajax({
            type: "get",
            url: server_url + "/dingdan/queryShouHuoArea",
            beforeSend: function (xhr) {//设置头部信息
                xhr.setRequestHeader(AUTH, $.cookie(TOKEN));
            },
            success: function (res) {
                if (res.code == 200) {

                    aretaList = res.data;
                    var html = "";
                    var shouHuoAreaData1 = $("#shouHuoAreaData1").html();
                    for (let i = 0; i < aretaList.length; i++) {
                        html += shouHuoAreaData1.replace(/##userName##/g, aretaList[i].userName)
                            .replace(/##area##/g, aretaList[i].area)
                            .replace(/##id##/g, aretaList[i].id)
                            .replace(/##check##/g, aretaList[i].status == 1 ? "selected" : "")
                            .replace(/##defalutArea##/g, aretaList[i].status == 1 ? "<span class=\"base\">默认地址</span>" : "")
                            .replace(/##phone##/g, aretaList[i].phone);
                        if (aretaList[i].status == 1) {

                            aretaListSelect = aretaList[i];
                            $("#areaDiv").html("寄送至:" + aretaList[i].area + " 收货人：" + aretaList[i].userName + " " + aretaList[i].phone);
                        }
                    }
                    $("#shouHuoArea").html(html);//收货地址拼接
                    //鼠标移上移出展示/不展示  修改和删除
                    initEvent();
                } else if (res.code == 6008 || res.code == 6010 || res.code == 6005) {//登录超时  信息不完整  头信息为空
                    location.href = "list.html";//跳转到登录页面
                }
            }, error: function (e) {
                alert("异常");
            }
        })
    }

    //
    function initEvent() {
        $(".con.address").hover(function () {
            $(this).children().last().show();
        }, function () {
            $(this).children().last().hide();
        })
    }

    //新增用户的收货地址
    function addShouHuoArea(dig) {
        var data = {};
        data.userName = $("#userName", dig).val();
        data.area = $("#area", dig).val();
        data.phone = $("#phone", dig).val();
        data.status = 1;//设置为默认地址
        $.ajax({
            type: "post",
            url: server_url + "/dingdan/addDingDan",
            data: data,
            beforeSend: function (xhr) {//设置头部信息
                xhr.setRequestHeader(AUTH, $.cookie(TOKEN));
            },
            success: function (res) {
                if (res.code == 200) {
                    initShouHuoArea();
                } else if (res.code == 6008 || res.code == 6010 || res.code == 6005) {//登录超时  信息不完整  头信息为空
                    location.href = "list.html";//跳转到登录页面
                }
            }, error: function (e) {
                alert("异常");
            }
        })
    }

    //修改收货地址
    function updateShouHuoArea(dig) {
        var data = {};
        data.userName = $("#update_userName", dig).val();
        data.area = $("#update_area", dig).val();
        data.phone = $("#update_phone", dig).val();
        data.id = $("#update_id", dig).val();
        console.log(data);
        // data.status = 1;//设置为默认地址
        $.ajax({
            type: "post",
            url: server_url + "/dingdan/updateDingDan",
            data: data,
            beforeSend: function (xhr) {//设置头部信息
                xhr.setRequestHeader(AUTH, $.cookie(TOKEN));
            },
            success: function (res) {
                if (res.code == 200) {
                    initShouHuoArea();
                } else if (res.code == 6008 || res.code == 6010 || res.code == 6005) {//登录超时  信息不完整  头信息为空
                    location.href = "list.html";//跳转到登录页面
                }
            }, error: function (e) {
                alert("异常");
            }
        })
    }

    //删除收货地址
    function delShouHuo(id) {
        $.ajax({
            type: "delete",
            url: server_url + "/dingdan/delShouHuoArea",
            data: {"id": id},
            beforeSend: function (xhr) {//设置头部信息
                xhr.setRequestHeader(AUTH, $.cookie(TOKEN));
            }, success: function (res) {
                if (res.code == 200) {
                    //初始化查询用户收货地址
                    initShouHuoArea();
                } else if (res.code == 6008 || res.code == 6010 || res.code == 6005) {//登录超时  信息不完整  头信息为空
                    location.href = "list.html";//跳转到登录页面
                }
            }, error: function (e) {
                alert("异常");
            }
        })
    }
</script>
</body>

</html>